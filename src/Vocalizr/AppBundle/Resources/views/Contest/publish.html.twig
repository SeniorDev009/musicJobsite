{% extends '::app.html.twig' %}

{% block title %}Publish your contest{% endblock %}

{% block stylesheet %}
    {% stylesheets
        '@VocalizrAppBundle/Resources/public/css/publish-project.css'
    %}
        <link rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}
{% endblock %}

{% block javascript %}

    {% javascripts
        '@VocalizrAppBundle/Resources/public/js/uploader/plupload.full.min.js'
        '@VocalizrAppBundle/Resources/public/js/audio-uploader.js'
        '@VocalizrAppBundle/Resources/public/js/publish-project.js'
     %}
        <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}

    <script>
       $('#publish-form').on('submit', function (e) {
            e.preventDefault();
            $('#deposit-amount').val($('#total-price').text());
            if (localStorage.getItem('{{ project.uuid }}')) {
                $('#paypal-popup').modal('show');
            } else {
                App.showLoading();
                localStorage.setItem('{{ project.uuid }}', 1);
                var lock_to_cert = $('input[name="project[lock_to_cert]"]').parent().hasClass('checked');
                var featured = $('input[name="project[featured]"]').parent().hasClass('checked');
                var messaging = $('input[name="project[messaging]"]').parent().hasClass('checked');
                var highlight = $('input[name="project[highlight]"]').parent().hasClass('checked');
                var publish_type = $('input[name="project[publish_type]"]').parent().hasClass('checked');
                var to_favorites = $('input[name="project[to_favorites]"]').parent().hasClass('checked');
                var restrict_to_preferences = $('input[name="project[restrict_to_preferences]"]').parent().hasClass('checked');
                var vocalizr_fee = $('#vocalizr-fee').text();
                var uuid = '{{ project.uuid }}';
                var param = {
                    'lock_to_cert' : lock_to_cert,
                    'featured' : featured,
                    'messaging' : messaging,
                    'highlight' : highlight,
                    'publish_type' : publish_type,
                    'to_favorites' : to_favorites,
                    'restrict_to_preferences' : restrict_to_preferences,
                    'uuid' : uuid,
                    'user_email' : "{{ app.user.email }}",
                    'vocalizr_fee' : vocalizr_fee,
                };
                $('input[name="custom"]').val(JSON.stringify(param));
                $.ajax({
                    url: '{{ path('contest_publish_confirm_via_wallet', {uuid: project.uuid}) }}',
                    method: 'POST',
                    data: {
                        project: {
                            price: $('#total-price').text() * 100,
                            lock_to_cert : lock_to_cert,
                            featured : featured,
                            messaging : messaging,
                            highlight : highlight,
                            publish_type : publish_type,
                            to_favorites : to_favorites,
                            restrict_to_preferences : restrict_to_preferences,
                            upgrades_amount_cents : (lock_to_cert + featured + messaging + highlight + publish_type + to_favorites + restrict_to_preferences) * 10,
                        }
                    },
                    success: function (data) {
                        if (data.success) {
                            window.location = $('#publish').data('confirm');
                        } else {
                            $('#payment-submit').click();
                        }
                    },
                    error: function () {
                        $('#payment-submit').click();
                    }
                });
            }

        });
    </script>
{% endblock %}

{% block body %}
<div class="publish-container row publish-contest">
    <div class="col-sm-8">
        <div class="row no-margin">
            <div class="col-sm-12">
                <div class="job-title-block">
                    <h1>Publish Your Job</h1>
                    <a href="{{ path('contest_new', {uuid: project.uuid}) }}" class="btn btn-default pull-right edit-job">Edit Job</a>
                </div>
            </div>
        </div>

        {% include 'VocalizrAppBundle::messages.html.twig' %}

        <div class="row no-margin">
            <div class="col-sm-12">

                {% if not app.request.get('success', false) %}
                    <h2>{{ project.title }}</h2>
                    <div class="headers">
                        <div class="free-header">Free Users</div>
                        <div class="pro-header"><b>Access Pass</b> Subscribers</div>
                    </div>
                    <form {% if app.user.isSubscribed %}class="subscribed" {% endif %}id="publish-form" action="{{ path('contest_new_publish', {uuid: project.uuid}) }}" data-uuid="{{ project.uuid }}" method="post">

                        {% include '@VocalizrApp/Project/include/addon_list.html.twig' %}

                        <div class="total-upgrades-group">
                            <div class="total-upgrades">
                                <div class="upgrades-label">
                                    Total
                                </div>
                                <div class="upgrades-value">
                                    $<span id="total-price">0</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <div id="payment" class="pull-right hide">
                                <a href="{{ path('project_new_cancel', {uuid: project.uuid}) }}" class="link-cancel" onclick="return confirm('Are you sure? All data for this gig will be lost.');">Cancel Job</a>
                                <button type="submit" name="pay" class="btn btn-primary pull-right" value="Pay & Publish">Pay & Publish Job</button>
                            </div>
                            <div id="publish" class="pull-right hide" data-confirm="{{ path('contest_publish_confirm', {uuid: project.uuid}) }}">
                                <a href="{{ path('project_new_cancel', {uuid: project.uuid}) }}" class="link-cancel" onclick="return confirm('Are you sure? All data for this gig will be lost.');">Cancel Job</a>
                                <button type="submit" name="publish" class="btn btn-primary pull-right" value="Publish Now">Publish Job</button>
                            </div>
                        </div>
                        <div id="userwallet-total" class="hide">{{ app.user.wallet }}</div>
                        <div id="price-amount" class="hide">0</div>

                    </form>
                {% else %}
                    <h2>{{ project.title }}</h2>
                    <p>Payment for your contest has been successful.</p>

                    <div class="form-actions">
                        <a href="{{ path('contest_publish_confirm', {uuid: project.uuid}) }}" class="btn btn-primary">Publish Now</a>
                    </div>
                {% endif %}

                <form id="payment-form" action="{{ paypal.url }}" method="post" target="_top" style="display:inline">
                    <input type="hidden" name="cmd" value="_xclick">
                    <input type="hidden" name="item_name" value="Deposit into Vocalizr Wallet" />
                    <input type="hidden" name="custom" value="DEPOSIT{{ app.user.uniqueStr }}" />
                    <input type="hidden" name="no_shipping" value="1" />
                    <input type="hidden" name="return" value="{{ url('project_publish_confirm', {uuid: project.uuid}) }}?success=1" />
                    <input type="hidden" name="cancel_return" value="{{ path('project_publish_confirm', {uuid: project.uuid}) }}?cancel=1" />
                    <input type="hidden" name="business" value="{{ paypal.primaryEmail }}">
                    <input type="hidden" name="lc" value="US">
                    <input type="hidden" name="currency_code" value="{{ paypal.currency }}">
                    <input type="hidden" name="no_note" value="0">
                    <input type="hidden" name="notify_url" value="{{ paypal.notifyUrl }}" />
                    <input id="deposit-amount" type="hidden" name="amount" value="0" />
                    <input id="payment-submit" type="submit" name="submit" value="submit" style="display:none;" />
                </form>
            </div>
        </div>

    </div>
    <div class="col-sm-4">
        <div class="panel panel-default welcome-panel">
            <div class="panel-heading">
                UPGRADE YOUR LISTING!
            </div>
            <div class="panel-body">
                <p>Add upgrades to your listing to increase the exposure of your contest and improve the quality and number of entries you receive.</p>
                <p>Listing upgrades are not refundable.</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block modals %}
    <div id="paypal-popup" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="vocalizr-modal" aria-hidden="true">
        {% include 'include/panel/block_pay_paypal.twig' %}
    </div>
{% endblock %}